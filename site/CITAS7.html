<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Calendario de Reservas</title>
<style>
  :root{
    --bg:#2e2f33;
    --panel:#3a3b40;
    --panel-2:#44454b;
    --ink:#e8e8ee;
    --muted:#b6b7c1;
    --accent:#cfd1da;
    --dot-free:#9ae6b4;
    --dot-warn:#f6e05e;
    --dot-busy:#fca5a5;
    --dot-weekend:#98a1aa;
    --today-ring:#f6e05e;
    --border:#52535a;
    --shadow: 0 12px 32px rgba(0,0,0,.45);
  }
  @font-face{
    font-family:"zag";
    src: local("Zag Regular"), local("Zag"), local("zag");
    font-display: swap;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; background:linear-gradient(180deg, #0263e0 0%, #2b2c30 60%, #27282c 100%);
        color:var(--ink); font-family:"zag", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .wrap{max-width:920px; margin:28px auto; padding:0 14px}
  .card{ background:#3a3b40; border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); overflow:hidden }
  .header{ padding:16px 14px; background:linear-gradient(180deg, #3b3c41 0%, #37383d 100%); border-bottom:1px solid var(--border) }
  .nav{ display:grid; grid-template-columns:40px 1fr 40px; align-items:center; gap:8px }
  .nav .title{ justify-self:center; font-weight:800; letter-spacing:.4px; background:#44454b;
               padding:6px 12px; border-radius:999px; border:1px solid var(--border) }
  .btn-nav{ width:38px; height:32px; border-radius:8px; border:1px solid var(--border); background:#44454b; color:var(--ink);
            display:grid; place-items:center; cursor:pointer; transition:.15s }
  .btn-nav:hover{ filter:brightness(1.08); box-shadow:0 6px 14px rgba(0,0,0,.35) }
  .arrow{width:0;height:0;border-top:6px solid transparent;border-bottom:6px solid transparent}
  .arrow.left{border-right:8px solid var(--accent)} .arrow.right{border-left:8px solid var(--accent)}
  .meta{display:flex; justify-content:space-between; padding:10px 16px; color:var(--muted); font-size:12px; flex-wrap:wrap; gap:8px}
  .cal{padding:8px 14px 18px}
  .cal-head{display:grid; grid-template-columns:repeat(7,1fr); gap:10px; padding:8px 2px; color:var(--muted); font-weight:800; font-size:12px}
  .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:10px}
  .day{ background:#44454b; border:1px solid var(--border); border-radius:10px; min-height:84px; padding:10px 10px 8px; display:flex; flex-direction:column; gap:6px; transition:.12s; cursor:pointer }
  .day:hover{filter:brightness(1.08)} .day.past{opacity:.6; cursor:default} .day.weekend{opacity:.75}
  .num{ font-weight:900; width:28px; height:28px; display:grid; place-items:center; border-radius:8px; border:1px solid transparent }
  .today .num{ border-color:#f6e05e; box-shadow:0 0 0 3px rgba(246,224,94,.12) inset }
  .dots{display:flex; gap:6px; align-items:center; margin-top:auto}
  .dot{width:8px;height:8px;border-radius:2px; box-shadow: inset 0 0 0 1px rgba(0,0,0,.25)}
  .legend{display:flex; gap:14px; align-items:center; padding:10px 14px; border-top:1px dashed var(--border); color:var(--muted); font-size:12px; flex-wrap:wrap}
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:18px; z-index:20}
  .modal{ background:#3a3b40; width:min(920px,96vw); max-height:90vh; overflow:auto; border-radius:12px; border:1px solid var(--border); box-shadow:var(--shadow) }
  .modal-head{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border) }
  .modal-title{ font-weight:900 } .close-x{ width:32px; height:28px; border-radius:8px; background:#44454b; border:1px solid var(--border); color:#e8e8ee; display:grid; place-items:center; cursor:pointer }
  .modal-body{ display:grid; grid-template-columns: 1.2fr .9fr; gap:14px; padding:14px }
  .slots{ display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:10px }
  .slot{ border:1px solid var(--border); background:#44454b; border-radius:10px; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; font-weight:800 }
  .slot.available{ outline:2px solid rgba(154,230,180,.18) } .slot.booked{ opacity:.9 } .slot .status{ font-size:11px; color:#b6b7c1 } .slot.disabled{ opacity:.5; filter:grayscale(.15) }
  .form{ border:1px dashed var(--border); background:#34353a; padding:12px; border-radius:10px; display:grid; gap:8px }
  label{ font-size:12px; color:#b6b7c1; font-weight:800 } input, select{ height:38px; border-radius:8px; border:1px solid var(--border); background:#2e2f33; color:#e8e8ee; padding:8px 10px; font-weight:800; width:100% }
  .btn{ display:inline-grid; place-items:center; height:38px; padding:0 14px; border-radius:8px; border:1px solid var(--border); background:#2f3035; color:#e8e8ee; font-weight:900; cursor:pointer }
  .btn[disabled]{ opacity:.5; cursor:not-allowed } .empty{ padding:10px; border:1px dashed var(--border); border-radius:8px; color:#b6b7c1; background:#333438 }
  .pill{ display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); background:#2e2f33; padding:6px 8px; border-radius:999px; font-weight:800 }
  .act{ border:1px solid var(--border); background:#3a3b40; border-radius:6px; padding:2px 6px; cursor:pointer } .act:hover{ filter:brightness(1.08) }
  .gallery{ display:flex; flex-direction:column; gap:8px } .booking{ border:1px solid var(--border); border-radius:10px; background:#34353a; padding:10px; display:flex; justify-content:space-between; align-items:center; gap:10px }
  .ok{ color:#9ae6b4 } .danger{ color:#fca5a5 } .toast{ position:fixed; bottom:16px; right:16px; background:#1f2023; color:#fff; padding:10px 12px; border-radius:8px; border:1px solid #38393f; box-shadow:0 0 20px rgba(0,0,0,.45); opacity:0; transform:translateY(6px); transition:.18s; z-index:50 }
  .toast.show{ opacity:1; transform:translateY(0) }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="nav">
          <button class="btn-nav" id="prevMonth" title="Mes anterior"><span class="arrow left"></span></button>
          <div class="title"><span id="monthName">Mes</span> <span id="year"></span></div>
          <button class="btn-nav" id="nextMonth" title="Mes siguiente"><span class="arrow right"></span></button>
        </div>
      </div>
      <div class="meta">
        <div>Zona horaria: <strong id="tz"></strong> · Hoy: <span id="todayChip"></span></div>
        <div>Duración: <strong>1:15</strong> · Pausa: <strong>15'</strong> · L–V 08:00–22:00 · Anticipación: <strong>≥48h</strong></div>
      </div>
      <div class="cal">
        <div class="cal-head">
          <div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div>
        </div>
        <div class="cal-grid" id="grid"></div>
      </div>
      <div class="legend">
        <span style="display:inline-flex;align-items:center;gap:6px"><i class="dot" style="background:#9ae6b4"></i> Disponible</span>
        <span style="display:inline-flex;align-items:center;gap:6px"><i class="dot" style="background:#f6e05e"></i> Hoy</span>
        <span style="display:inline-flex;align-items:center;gap:6px"><i class="dot" style="background:#fca5a5"></i> Reservado / Pasado / &lt;48h</span>
        <span style="display:inline-flex;align-items:center;gap:6px"><i class="dot" style="background:#98a1aa"></i> Fin de semana</span>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">—</div>
        <button class="close-x" id="closeModal" aria-label="Cerrar">✕</button>
      </div>
      <div class="modal-body">
        <div class="col">
          <div class="slots" id="slots"></div>
          <div id="dayEmpty" class="empty" style="display:none; margin-top:10px">No hay franjas disponibles para reservar en esta fecha.</div>
          <div class="gallery" id="bookings" style="margin-top:10px"></div>
        </div>
        <div class="col">
          <form class="form" id="form">
            <div class="empty" style="border-style:solid; background:#2c2d31">Reservar — completa tus datos. Una vez guardada, la marcación no podrá alterarse (solo profesor ✓/✗).</div>
            <div><label for="iNombre">Nombre del alumno</label><input id="iNombre" placeholder="Ej.: Ana López" required></div>
            <div><label for="iNivel">Nivel</label><select id="iNivel" required><option value="">Selecciona…</option><option>A1</option><option>A2</option><option>B1</option><option>B2</option><option>C1</option><option>C2</option></select></div>
            <div><label for="iEmail">Correo electrónico</label><input id="iEmail" type="email" placeholder="nombre@correo.com" required></div>
            <div><label>Franja elegida</label><div id="chosen" class="empty">Ninguna</div></div>
            <button type="submit" class="btn" id="btnSave" disabled>Guardar marcación</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Listo</div>

<script>
// ... (todo tu código anterior)

form.addEventListener('submit', e=>{
  e.preventDefault();
  if(chosenStart===null||!currentDate) return;

  const name  = $('#iNombre').value.trim();
  const level = $('#iNivel').value.trim();
  const email = $('#iEmail').value.trim().toLowerCase();
  if(!name||!level||!email) return toast('Completa todos los campos');
  if(!isValidEmail(email)) return toast('Correo no válido');

  saveProfile({name, level, email});

  const dayISO = toISODate(currentDate);
  const start  = chosenStart;
  const end    = start + DURATION;

  const dataList = read();
  if(dataList.some(b=>b.date===dayISO && b.start===fmtHM(start))) return toast('Esa franja ya está reservada');
  if(isWeekend(currentDate)) return toast('No se aceptan reservas en fines de semana');
  if(isPastDate(currentDate)||isPastTime(currentDate,start)) return toast('No se puede reservar en el pasado');
  if(!hasLeadTime(currentDate,start)) return toast('Debes reservar con ≥48 horas de anticipación');

  // Regla 2 franjas consecutivas
  const ownToday = dataList.filter(b=>b.email===email && b.date===dayISO).map(b=>b.start).sort();
  if(ownToday.length>=2) return toast('Ya tienes 2 reservas consecutivas en este día.');
  if(ownToday.length===1){
    const onlyStart = Number(ownToday[0].slice(0,2))*60 + Number(ownToday[0].slice(3));
    if(!(start===onlyStart+90 || start===onlyStart-90))
      return toast('Solo puedes añadir la franja consecutiva (±1:30) en este día.');
  }

  const id = `${dayISO}-${fmtHM(start)}-${email}`;
  dataList.push({
    id, date:dayISO,
    start:fmtHM(start), end:fmtHM(end),
    name, level, email,
    status:'pending',
    createdAt:new Date().toISOString()
  });
  save(dataList);

  // ---- NUEVO: construir fecha/hora legibles y asunto "Reservación de cita — Nombre"
  const whenDT       = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate(), Math.floor(start/60), start%60);
  const fechaLegible = new Intl.DateTimeFormat('es-ES',{dateStyle:'full'}).format(whenDT);
  const horaLegible  = `${String(whenDT.getHours()).padStart(2,'0')}:${String(whenDT.getMinutes()).padStart(2,'0')}–${fmtHM(end)}`;
  const asunto       = `Reservación de cita — ${name}`;

  // Enviar al profesor (no pasamos "to", el API usa SENDGRID_TO por defecto)
  sendEmail({
    subject: asunto,
    data: {
      name, level, email,
      fecha: fechaLegible,
      hora:  horaLegible,
      tipo:  'reserva'
    }
  });

  toast('Marcación guardada');
  render(); renderDay(currentDate);

  chosenStart=null;
  $('#chosen').textContent='Ninguna';
  $('#btnSave').disabled=true;
});

// ... (sigue tu código)
</script>


<!-- Email helper (corregido) -->
<script>
async function sendEmail(payload) {
  try {
    const res = await fetch('/api/send-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const out = await res.json().catch(() => null);
    if (out && out.ok) {
      console.log('Email enviado ✓');
    } else {
      console.warn('Error al enviar email:', out);
    }
  } catch (e) {
    console.error('Fallo al enviar email:', e);
  }
}
</script>
</body>
</html>
